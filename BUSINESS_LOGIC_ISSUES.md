# Список недочетов и расхождений в бизнес-логике функции "Саммари постов канала"

## Критические расхождения

### 1. Размер батча для LLM не соответствует ТЗ
**ТЗ (п.2.4):** "Обработка должна производиться батчами максимум по 15 постов за раз."

**Реализация:** `LLM_BATCH_SIZE = 10` (строка 52 в `summary-channel.service.ts`)

**Проблема:** Используется батч размером 10 вместо 15, что может привести к большему количеству запросов к LLM и увеличению времени обработки.

---

### 2. Отсутствует проверка лимита каналов при добавлении второго канала
**ТЗ (п.1.3.8):** "Если в MVP уже подключен 1 канал и пользователь пытается добавить второй — нужно вывести сообщение о лимите (1 канал) и кнопку "Главное меню"."

**Реализация:** В `summary-channel.flow.ts` (строки 336-348) проверка есть, но:
- Сообщение выводится через `showMyChannels` с notice, а не отдельным сообщением с кнопкой "Главное меню"
- Кнопка "Главное меню" отсутствует в этом случае

**Проблема:** UX не соответствует ТЗ - пользователь видит список каналов вместо четкого сообщения об ошибке с кнопкой "Главное меню".

---

### 3. Отсутствует сообщение о следующем саммари после немедленной генерации
**ТЗ (п.1.3.7):** "Отдельным сообщением прислать: 'Следующее саммари пришлю: 05.01.2026 21:10.' // время и дата = текущее время + окно саммари."

**Реализация:** В `summary-channel.flow.ts` метод `sendImmediateSummary` (строки 446-478) отправляет только саммари, без сообщения о следующей генерации.

**Проблема:** Пользователь не информирован о времени следующего саммари.

---

### 4. Отсутствует выбор окна саммари (24ч/3дня/7дней)
**ТЗ (п.1.3.7):** "После подключения канала или по кнопке «Саммари канала» вывести три кнопки с выбором окна саммари: 24 часа, 3 дня, 7 дней."

**Реализация:** 
- Нет кнопки "Саммари канала" в меню
- Нет выбора окна саммари
- Всегда используется фиксированное окно 24 часа

**Проблема:** Функционал выбора окна саммари полностью отсутствует.

---

### 5. Немедленное саммари запускается автоматически без выбора окна
**ТЗ (п.1.3.7):** "После выбора окна саммари, сгенерировать ответ с саммари за выбранный период."

**Реализация:** В `summary-channel.flow.ts` (строки 186-192) саммари запускается сразу после добавления канала без выбора окна.

**Проблема:** Нарушена последовательность действий согласно ТЗ.

---

### 6. Лимит 1 генерация/24ч проверяется неправильно
**ТЗ (п.3):** "Берём последний запуск немедленного саммари по `user_id`. Если `now - last.created_at < 24h`: не запускаем генерацию, отвечаем пользователю сообщением..."

**Реализация:** В `summary-channel.service.ts` метод `checkImmediateLimit` (строки 370-418):
- Проверяет `startedAt`, а не `createdAt`
- Проверяет только последний успешный запуск (`status = Success`), но не учитывает, что может быть запуск в статусе `Running`

**Проблема:** 
- Используется неправильное поле для проверки времени
- Если есть запуск в статусе `Running`, проверка может пропустить его и разрешить новый запуск

---

### 7. Сообщение об ошибке при лимите не содержит `next_allowed_at`
**ТЗ (п.3):** "Следующая попытка доступна: <next_allowed_at>"

**Реализация:** В `summary-channel.service.ts` (строки 412-417) выводится только "Попробуйте снова через Xч Xм", но не конкретная дата/время.

**Проблема:** Пользователь не видит точное время, когда сможет снова запустить генерацию.

---

### 8. Текст сообщения при пустом результате не соответствует ТЗ
**ТЗ (п.2.8):** "Если постов за выбранный промежуток времени не оказалось, нужно выводить сообщение с текстом 'Нет постов для саммари в канале @channel_name'."

**Реализация:** В `summary-channel.service.ts` (строки 145-148) используется текст: "There are no suitable text posts in the ${channelUsernameWithAt} channel for the recent period."

**Проблема:** 
- Текст на английском вместо русского
- Формат не соответствует ТЗ (нет @channel_name в нужном формате)

---

### 9. Заголовок дайджеста не соответствует ТЗ
**ТЗ (п.2.6):** "После создания саммари пользователю будет отправлено сообщение с заголовком 'Саммари за последние 24 часа: @channel'"

**Реализация:** В `summary-channel.service.ts` (строка 549) используется: "Дайджест за последние 24ч: @channel"

**Проблема:** 
- Используется слово "Дайджест" вместо "Саммари"
- Формат "24ч" вместо "24 часа"

---

### 10. Формат ссылки в дайджесте не соответствует ТЗ
**ТЗ (п.2.6):** "каждый пункт представляет из себя суммированный текст и ссылку на оригинальный пост в формате 1) Саммари — [ссылка]."

**Реализация:** В `summary-channel.service.ts` (строка 561) используется формат: "1. Саммари\n<a href='url'>К оригинальному посту →</a>"

**Проблема:** 
- Используется "К оригинальному посту →" вместо просто "[ссылка]"
- Формат не соответствует ТЗ (должно быть "Саммари — [ссылка]" в одной строке)

---

### 11. Отсутствует обработка коротких постов (<10 слов) в формате ТЗ
**ТЗ (п.2.3):** "Если текст короткий (меньше 10 слов), то нужно оставить его в оригинальном виде и все равно добавить в дайджест в формате 1) оригинальный текст — [ссылка]."

**Реализация:** В `summary-channel.service.ts` (строки 443-444) короткие посты обрабатываются, но формат вывода такой же, как для обычных саммари.

**Проблема:** В дайджесте не видно, что это оригинальный текст, а не саммари.

---

### 12. Отсутствует проверка на закрытые каналы и ограничения лимитов
**ТЗ (п.1.3.3):** "Для закрытых каналов и / или при невозможности найти канал по имени ограничении лимитов, валидации ввода или любых других ошибках нужно выводить соотв сообщение об ошибке с кнопкой 'Главное меню'."

**Реализация:** В `summary-channel.flow.ts` (строки 86-116) есть обработка ошибок `getChat`, но:
- Нет явной проверки на закрытые каналы (только общая обработка ошибок)
- Сообщения об ошибках не всегда содержат кнопку "Главное меню" (используется `buildSummaryChannelMainMenuOnlyKeyboard` только в `failAddChannelAndExitToMainMenu`)

**Проблема:** Не все ошибки обрабатываются с кнопкой "Главное меню".

---

### 13. Отсутствует автоматическое закрытие состояния через 60 секунд
**ТЗ (Backlog п.9):** "Если пользователь не ввел название канала в течении 60 секунд, то состояние должно закрываться для исключения потенциальных подводных камней."

**Реализация:** Нет механизма автоматического закрытия состояния по таймауту.

**Проблема:** Состояние может оставаться активным неограниченно долго.

---

### 14. Отсутствует обработка случая, когда пользователь выходит из состояния
**ТЗ (Backlog п.7):** "Если пользователь открыл состояние но вместо него вышел, нажал другие кнопки / команды или что угодно еще кроме отправки текста в чат, состояние должно быть закрыто."

**Реализация:** В `message.router.ts` состояние проверяется только при наличии текста. Если пользователь нажимает другие кнопки/команды, состояние не очищается.

**Проблема:** Состояние может "зависнуть", если пользователь переключился на другую функцию.

---

### 15. Плановая генерация не проверяет наличие саммари за последние 24 часа правильно
**ТЗ (п.2.1):** "Плановая генерация должна обрабатывать **только те пары user+channel**, по которым **не было саммари за последние 24 часа**"

**Реализация:** В `summary-channel.service.ts` метод `shouldSkipPlannedRun` (строки 292-326):
- Проверяет только плановые запуски (`isImmediateRun = false`) - строка 317
- НО не учитывает, что может быть немедленный запуск, который тоже считается саммари за последние 24 часа

**Проблема:** Если был немедленный запуск менее 24 часов назад, плановая генерация все равно может запуститься, что приведет к дублированию. По ТЗ нужно проверять ВСЕ саммари (и плановые, и немедленные) за последние 24 часа для пары user+channel.

---

### 16. Отсутствует сохранение ссылки на пост в БД
**ТЗ (п.2.7):** "Оригинальный текст, текст саммари и ссылку на пост и потенциальные ошибки обработки постов сохраняем в БД"

**Реализация:** В `summary-channel-result.entity.ts` нет поля для хранения ссылки на пост.

**Проблема:** Ссылка на пост не сохраняется в БД, хотя требуется по ТЗ.

---

### 17. Проверка на канал vs группа может быть недостаточной
**ТЗ (п.1.3.1):** "В текущей версии функция должна работать только для каналов и четко проверять что это не группа а именно канал."

**Реализация:** В `summary-channel.flow.ts` (строка 118) проверяется `chat.type !== 'channel'`, но нет дополнительной проверки, что это именно публичный канал (не supergroup).

**Проблема:** Может быть недостаточно строгая проверка типа чата.

---

### 18. Отсутствует кнопка "Саммари канала" в меню
**ТЗ (п.1.3.7):** "После подключения канала или по кнопке «Саммари канала» вывести три кнопки с выбором окна саммари"

**Реализация:** В `summary-channel.keyboard.ts` нет кнопки "Саммари канала" в основном меню.

**Проблема:** Пользователь не может запустить немедленное саммари для уже подключенного канала.

---

### 19. Сообщение при успешном добавлении канала не полностью соответствует ТЗ
**ТЗ (п.1.3.2):** "✅ Канал @test_chabbel_123 подключён к channel-summary., вы будете получать саммари по нему раз в день (в фиксированное время)"

**Реализация:** В `summary-channel.flow.ts` (строка 180) используется точно такой же текст.

**Статус:** ✅ Соответствует ТЗ

---

### 20. Обработка медиа-постов с caption
**ТЗ (п.0, п.2.2):** "Для сообщений без текста (только media / кружок / стикер / смайл) саммари не делаем. В случае если помимо media есть еще и текст нужно делать саммари по нему."

**Реализация:** В `summary-channel.service.ts` метод `fetchRecentTextPostsForChannel` (строки 637-642) использует `.tgme_widget_message_text.js-message_text`, который должен содержать и текст, и caption. Если текст пустой, пост пропускается.

**Статус:** ✅ Логика правильная - web scraping через этот селектор захватывает и текст, и caption. Посты только с media без caption будут пропущены (строка 642: `if (!text) return;`).

---

### 21. Сортировка постов может быть неправильной
**ТЗ (п.2.10):** "Сортировка в саммари должна быть по возрастанию времени публикации постов."

**Реализация:** В `summary-channel.service.ts` (строки 672-676) сортировка есть, но:
- Используется `date.getTime()` для сравнения
- Если у поста нет даты (`date` undefined), он попадает в конец с `Number.POSITIVE_INFINITY`

**Проблема:** Посты без даты могут быть отсортированы неправильно.

---

### 22. Отсутствует обработка случая, когда канал уже подключен другим пользователем
**ТЗ (п.2.12):** "Так как канал уже может быть добавлен в таблицу channel другим пользователем, в том числе даже админом - для данной функции мы не должны давать прав проверок канала, управления и так далее пользователю который добавил его себе в рамках функции обычного саммари"

**Реализация:** В `summary-channel.flow.ts` при добавлении канала устанавливается `isAdmin: false` (строка 155), что правильно. Но нет явной проверки или документации этого требования.

**Статус:** ✅ Логика правильная, но стоит добавить комментарий для ясности

---

### 23. Формат сообщения "Мои каналы" не полностью соответствует ТЗ
**ТЗ (п.1.2.1):** "Ваши каналы для channel-summary: • @test_channel_123"

**Реализация:** В `summary-channel.flow.ts` (строки 305-312) используется формат с предупреждением о лимите и списком каналов.

**Проблема:** Если каналов нет, формат правильный. Но если каналы есть, добавляется предупреждение о лимите, которого нет в ТЗ для этого случая.

---

### 24. Отсутствует обработка случая, когда пользователь нажимает "Назад" во время ввода канала
**ТЗ (п.1.3.Уточнения.1):** "На каждом экране должна быть кнопка 'Назад' ведущая на предыдущий экран. По нажатию должно также сбрасываться состояние"

**Реализация:** В `summary-channel.flow.ts` метод `handleCancelAdd` (строки 368-378) сбрасывает состояние и возвращает в меню.

**Статус:** ✅ Соответствует ТЗ

---

### 25. Отсутствует проверка на дублирование постов при парсинге
**ТЗ (неявно):** Посты не должны дублироваться в саммари.

**Реализация:** В `summary-channel.service.ts` (строки 575, 645-648) используется `seenPostIds` для предотвращения дублирования.

**Статус:** ✅ Соответствует ТЗ

---

## Средние расхождения

### 26. Разделение сообщений на части может быть неоптимальным
**ТЗ (п.2.11, Backlog п.8):** "Если сформированное сообщение с саммари получилось слишком большим (лимиты телеграм) — разделить его на несколько отдельных сообщений."

**Реализация:** В `summary-channel.service.ts` метод `splitTelegramMessage` (строки 785-813) есть, но:
- Используется лимит 3500 символов (может быть слишком много для Telegram)
- Разделение происходит по `\n\n`, что может разорвать структуру дайджеста

**Проблема:** Может быть неоптимальное разделение сообщений.

---

### 27. Отсутствует явная обработка ошибок при парсинге HTML
**ТЗ (неявно):** Ошибки парсинга должны обрабатываться корректно.

**Реализация:** В `summary-channel.service.ts` метод `fetchRecentTextPostsForChannel` обрабатывает ошибки fetch, но не все ошибки парсинга HTML.

**Проблема:** Могут быть необработанные исключения при парсинге.

---

## Мелкие недочеты

### 28. Константа HOURS_WINDOW жестко задана как 24
**ТЗ (п.1.3.7):** Предполагается выбор окна (24ч/3дня/7дней).

**Реализация:** `HOURS_WINDOW = 24` захардкожено.

**Проблема:** Невозможно использовать другие окна без изменения кода.

---

### 29. Отсутствует логирование важных событий
**ТЗ (неявно):** Важные события должны логироваться.

**Реализация:** Логирование есть, но может быть недостаточным для некоторых критических операций.

**Статус:** ⚠️ Требует уточнения требований

---

### 30. Отсутствует явная обработка случая, когда канал был удален из Telegram
**ТЗ (неявно):** Если канал был удален или стал недоступным, это должно обрабатываться корректно.

**Реализация:** В `summary-channel.service.ts` метод `fetchRecentTextPostsForChannel` обрабатывает ошибки fetch (строки 589-595), но при плановой генерации ошибка может быть проигнорирована.

**Проблема:** При плановой генерации, если канал стал недоступен, пользователь не получит уведомление об ошибке.

---

### 31. Проверка лимита каналов выполняется дважды
**ТЗ (п.1.3.8):** Лимит 1 канал должен проверяться при добавлении.

**Реализация:** 
- В `startAddChannel` (строки 336-348) проверяется лимит
- Но также в `handleState` после успешного добавления канала нет повторной проверки перед сохранением

**Проблема:** Теоретически возможна race condition, если пользователь быстро добавит два канала одновременно (хотя это маловероятно в MVP).

---

### 32. Отсутствует валидация формата username при вводе
**ТЗ (п.1.3.2):** "Отправьте @username канала, который хотите подключить к channel-summary."

**Реализация:** В `summary-channel.flow.ts` метод `normalizeChannelUsername` (строки 440-444) добавляет @ если его нет, но не валидирует формат username (должен быть валидный Telegram username).

**Проблема:** Пользователь может ввести некорректный формат, и ошибка будет обнаружена только при вызове `getChat`.

---

## Итоговая сводка

**Критические расхождения:** 15
**Средние расхождения:** 2
**Мелкие недочеты:** 5
**Соответствует ТЗ:** 6

**Общее количество найденных проблем:** 28

