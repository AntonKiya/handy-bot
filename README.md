# üì¶ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Telegram-–±–æ—Ç–∞

## 1. Overview

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞ 4 —Å–ª–æ—è:

- **Transport Layer** ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö Telegram-—Å–æ–±—ã—Ç–∏–π
- **Routers** ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥, —Ç–µ–∫—Å—Ç–∞ –∏ –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–¥—É–ª–∏
- **Feature Modules** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, –≤—ã–Ω–µ—Å–µ–Ω–Ω–∞—è –ø–æ —Ñ–∏—á–∞–º –±–æ—Ç–∞
- **State Management** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ (Redis/session)

–ë–æ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **NestJS + Telegraf** —Å —á—ë—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π.

---

## 2. Transport Layer

Transport Layer —Å–æ–∑–¥–∞—ë—Ç –æ–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä `bot` –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

### –¢—Ä–∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞:
```typescript
bot.command('*', ctx => commandRouter.route(ctx));
bot.on('text', ctx => textRouter.route(ctx));
bot.on('callback_query', ctx => callbackRouter.route(ctx));
```

**Transport Layer:**
- –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫–∏
- –Ω–µ –∑–Ω–∞–µ—Ç –Ω–∏—á–µ–≥–æ –æ —Ñ–∏—á–∞—Ö –±–æ—Ç–∞
- —Ç–æ–ª—å–∫–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞–ø–¥–µ–π—Ç—ã –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å

---

## 3. Routers

### CommandRouter

–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã:
```
/start ‚Üí onboardingModule.start()
/help ‚Üí onboardingModule.help()
/summary ‚Üí summaryModule.start()
```

### TextRouter

–û–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞, —Å —É—á—ë—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```typescript
if (state.type === 'channel_summary') summaryModule.handleStep()
else dialogModule.handleGeneralText()
```

### CallbackRouter

–û–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö inline-–∫–Ω–æ–ø–æ–∫:
```
menu:* ‚Üí menuModule
channels:* ‚Üí channelSummaryModule
billing:* ‚Üí billingModule
admin:* ‚Üí adminModule
```

**Namespace callback_data:**
```
menu:channels
menu:subscription
channels:list
billing:pay
...
```

---

## 4. Feature Modules

–ö–∞–∂–¥–∞—è —Ñ–∏—á–∞ –±–æ—Ç–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:

- handler'—ã —Å–æ–±—ã—Ç–∏–π
- –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- keyboard-builders
- –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ flow-—Å—Ü–µ–Ω–∞—Ä–∏–∏

**–ú–æ–¥—É–ª–∏ –Ω–µ –∑–Ω–∞—é—Ç –æ Telegraf.**  
–û–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç —á–∏—Å—Ç—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç —Ä–æ—É—Ç–µ—Ä–æ–≤.

### –ü—Ä–∏–º–µ—Ä—ã –º–æ–¥—É–ª–µ–π:

- `MenuModule`
- `ChannelSummaryModule`
- `AnalyticsModule`
- `BillingModule`
- `OnboardingModule`
- `AdminModule`

---

## 5. State Management

–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è state-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ:
```json
{
  "userId": 123,
  "type": "channel_summary",
  "step": "wait_for_channel_link",
  "data": {}
}
```

### –•—Ä–∞–Ω–µ–Ω–∏–µ:

- **Redis** (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)
- –∏–ª–∏ Telegraf session adapters

`TextRouter` –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π flow-–º–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π state –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è.

---

## 6. Inline-–∫–Ω–æ–ø–∫–∏ –∏ –º–µ–Ω—é

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥—Ö–æ–¥ —Å **—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π**:
```typescript
ctx.editMessageText(newText, newKeyboard);
```

### –ü—Ä–∏—á–∏–Ω—ã:

- –Ω–µ –∑–∞—Å–æ—Ä—è–µ—Ç —á–∞—Ç
- UX –∫–∞–∫ "—ç–∫—Ä–∞–Ω—ã" –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞
- –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –ª–æ–∂–∏—Ç—Å—è –Ω–∞ `callbackRouter`
- –ª–µ–≥–∫–æ —Å—Ç—Ä–æ–∏—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –º–µ–Ω—é

### –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –∏–º–µ–µ—Ç —Å–≤–æ–π keyboard builder:
```typescript
Markup.inlineKeyboard([
  [{ text: '–ö–∞–Ω–∞–ª—ã', callback_data: 'menu:channels' }],
  [{ text: '–ì—Ä—É–ø–ø—ã', callback_data: 'menu:groups' }],
  [{ text: '–ü–æ–¥–ø–∏—Å–∫–∞', callback_data: 'menu:subscription' }],
])
```

---

## 7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–ú–æ–¥—É–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

- –≤–Ω–µ—à–Ω–∏–µ API
- –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –æ—á–µ—Ä–µ–¥–∏ (BullMQ)
- LLM-—Å–µ—Ä–≤–∏—Å—ã
- Telegram Core API (gramjs/tdlib)

**Transport Layer –∏ Routers –æ—Ç —ç—Ç–æ–≥–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã.**

---

## 8. –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
```
src/
  telegram/
    telegram.module.ts
    telegram-update.service.ts
    routers/
      command.router.ts
      text.router.ts
      callback.router.ts

  modules/
    menu/
      menu.module.ts
      menu.handler.ts
      menu.keyboard.ts

    channel-summary/
      channel-summary.module.ts
      channel-summary.flow.ts
      channel-summary.service.ts

    billing/
      billing.module.ts
      billing.handler.ts
      billing.service.ts

    onboarding/
      onboarding.module.ts
      onboarding.handler.ts
      onboarding.service.ts

    admin/
      admin.module.ts
      admin.handler.ts
      admin.service.ts

  common/
    state/
    utils/
    decorators/
```

---

## 9. –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–û–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π bot** ‚Üí —Ç—Ä–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –≤—Ö–æ–¥–∞ (command/text/callback)
2. **Transport Layer** = —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
3. **–†–æ—É—Ç–µ—Ä—ã** = –º–æ–∑–≥ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
4. **–ú–æ–¥—É–ª–∏** = –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
5. **Inline-–∫–Ω–æ–ø–∫–∏** = —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π, –∞ –Ω–µ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
6. **–ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏** = state –≤ Redis
7. **Callback-data** = —Å—Ç—Ä–æ–≥–∏–π namespace-–ø–æ–¥—Ö–æ–¥ (`module:action[:payload]`)

---

## üìå –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è

### 1. –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ callback_data

–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞:
```
namespace:action[:payload]
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```
menu:channels
channels:list
channels:select:123456
billing:pay:premium
admin:users:ban:987654
```

---

### 2. –ü—Ä–∞–≤–∏–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π (—Ñ–∏—á)

**–ü–æ—à–∞–≥–æ–≤–æ:**

1. –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å –≤ `src/modules/<module-name>/`
2. –î–æ–±–∞–≤–∏—Ç—å namespace-–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–æ—É—Ç–µ—Ä
3. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (`*.keyboard.ts`)
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å flow/state (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)
5. –ü–æ–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç–∞–º–∏

---

### 3. –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å–æ state

- **–ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:** –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
- **–ö–æ–≥–¥–∞ –æ—á–∏—â–∞–µ—Ç—Å—è:** –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è flow –∏–ª–∏ –æ—Ç–º–µ–Ω—ã
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:**
    - `userId` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - `type` ‚Äî —Ç–∏–ø —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
    - `step` ‚Äî —Ç–µ–∫—É—â–∏–π —à–∞–≥ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏
    - `data` ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—è

---

### 4. UI/UX-–≥–∞–π–¥—ã

- ‚úÖ **–í—Å–µ–≥–¥–∞** —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (`editMessageText`)
- ‚ùå **–ò–∑–±–µ–≥–∞—Ç—å** —Å–ø–∞–º–∞ –Ω–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ –ø–æ–¥–º–µ–Ω—é
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

---

### 5. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—é

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:**

- ‚úÖ –ö–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É (`/start`, `/help`, etc.)
- ‚úÖ –ö–∞–∂–¥–æ–µ text-—Å–æ–æ–±—â–µ–Ω–∏–µ (—Å —É—á—ë—Ç–æ–º state)
- ‚úÖ –ö–∞–∂–¥—ã–π callback (inline-–∫–Ω–æ–ø–∫–∞)
- ‚úÖ –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤:**
```typescript
logger.log(`[Command] /start from user ${userId}`);
logger.log(`[Text] User ${userId} in state ${state.type}:${state.step}`);
logger.log(`[Callback] ${callbackData} from user ${userId}`);
logger.error(`[Error] ${error.message}`, error.stack);
```

---

## üöÄ Quick Start
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –ó–∞–ø—É—Å–∫ –≤ dev-—Ä–µ–∂–∏–º–µ
npm run start:dev

# –ó–∞–ø—É—Å–∫ –≤ production
npm run build
npm run start:prod
```
